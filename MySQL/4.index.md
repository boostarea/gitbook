## 索引神乎奇迹

索引的出现就是为了提高数据查询的效率，就像书的目录一般。

### 常见模型

1. 哈希表：做区间查询速度很慢，只适合等值查询场景。
2. 有序数组：等值与范围查询都非常优秀，但只适用于做静态存储引擎，插入成本太高。
3. 搜索树：需要使用N叉树（二叉树造成频繁访问磁盘），InnoDB的N大约为1200。

### InnoDB的索引模型

1. 索引组织表：表根据主键顺序以索引的形式存放。
2. 使用B+树索引模型，所以数据都是存储在B+树中。
3. 每个索引就是一颗B+树。
4. 主键索引（聚簇索引）：叶子节点存放整行数据。
5. 非主键索引（二级索引）：叶子节点存放主键的值，查询整行数据时，需要回表再查一次。

### 索引维护

1. B+树维持有序性，插入新值，需要做必要维护。
2. 页分裂：但数据页已满，则需要申请一个新的数据页，挪动部分数据过去。
3. 使用 自增主键：没插入一条都是追加操作，不涉及挪动其他数据，不触发页分裂。
4. 由于每个非主键索引的叶子节点都是主键值，所以主键长度越小，普通索引占用的空间也就越小。

### 减少回表次数

在满足语句需求的情况下，尽量少地访问资源是数据库设计的重要原则，减少资源消耗。

#### 覆盖索引

1. 索引已经覆盖查询需求，（索引k，j， 用k查询j， 则不需要回表）。

#### 最左前缀原则

1. 既可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符。
2. 安排好索引内的字段顺序，第一原则：通过调整顺序，可以少维护一个索引； 其次：考虑空间，若name字段比age大，索引应为（name， age）与（age）。

#### 索引下推

1. 若索引（name，age），查询 name like ‘陈%’ and age=10；只用了name索引。
2. v5.6之前，只能回表，再对比age字段值。
3. v5.6之后，索引下推优化（pushdown），索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。 